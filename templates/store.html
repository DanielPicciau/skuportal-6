{% extends 'base.html' %}
{% block content %}
<style>
  /* Hide app nav on store and provide store-specific nav */
  nav.sticky{ display:none; }
</style>
<div class="sticky top-0 z-50 backdrop-blur-md bg-white/70 dark:bg-slate-900/70 border-b border-black/10 dark:border-white/10">
  <div class="max-w-6xl mx-auto px-3 sm:px-4 py-2 flex items-center gap-3">
    <a href="/store/" class="text-lg font-bold">Store</a>
    <form method="get" class="ml-auto hidden md:flex items-center gap-2">
      <label for="store-q" class="sr-only">Search</label>
      <input id="store-q" name="q" value="{{ q }}" placeholder="Search…" class="w-64 bg-white/10 border border-white/10 rounded-xl p-2.5">
      <button type="submit" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Search</button>
      <a href="{% url 'store_cart' %}" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Cart</a>
    </form>
    <a href="{% url 'store_cart' %}" class="ml-auto md:hidden px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Cart</a>
  </div>
</div>
<div class="max-w-6xl mx-auto">
  <div class="store-hero card p-6 mb-6 mt-2">
    <div class="flex items-end justify-between gap-3 flex-wrap">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Shop</h1>
        <p class="text-slate-300">Hand‑picked listings, updated as you post.</p>
      </div>
      <form method="get" class="w-full md:w-auto grid grid-cols-1 md:grid-cols-5 gap-2">
        <label for="store-q2" class="sr-only">Search</label>
        <input id="store-q2" name="q" value="{{ q }}" placeholder="Search products, brand, SKU…" class="md:col-span-2 bg-white/10 border border-white/10 rounded-xl p-3" />
        <select name="sort" class="bg-white/10 border border-white/10 rounded-xl p-3">
          <option value="newest" {% if sort == 'newest' or not sort %}selected{% endif %}>Newest</option>
          <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Price: Low → High</option>
          <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Price: High → Low</option>
        </select>
        <div class="flex items-center gap-2 bg-white/10 border border-white/10 rounded-xl p-2">
          <span class="text-xs text-slate-300">£</span>
          <input type="number" name="min_price" value="{% if min_price %}{{ min_price }}{% endif %}" placeholder="Min" step="5" class="w-24 bg-transparent outline-none">
          <span class="text-slate-400">–</span>
          <span class="text-xs text-slate-300">£</span>
          <input type="number" name="max_price" value="{% if max_price %}{{ max_price }}{% endif %}" placeholder="Max" step="5" class="w-24 bg-transparent outline-none">
        </div>
        <button type="submit" class="btn btn-primary">Apply</button>
      </form>
      {% if bounds.mn and bounds.mx %}
      <div class="w-full mt-3 grid grid-cols-2 md:grid-cols-4 gap-2 items-center">
        <div class="text-xs text-slate-400">Price range</div>
        <div class="col-span-1 md:col-span-3 flex items-center gap-3">
          <input id="minRange" type="range" min="{{ bounds.mn }}" max="{{ bounds.mx }}" step="5" value="{% if min_price %}{{ min_price }}{% else %}{{ bounds.mn }}{% endif %}" class="flex-1">
          <input id="maxRange" type="range" min="{{ bounds.mn }}" max="{{ bounds.mx }}" step="5" value="{% if max_price %}{{ max_price }}{% else %}{{ bounds.mx }}{% endif %}" class="flex-1">
        </div>
      </div>
      <script>
        (function(){
          const minR = document.getElementById('minRange');
          const maxR = document.getElementById('maxRange');
          const minN = document.querySelector('input[name=min_price]');
          const maxN = document.querySelector('input[name=max_price]');
          if(!minR || !maxR) return;
          function sync(){
            let a = parseInt(minR.value, 10), b = parseInt(maxR.value, 10);
            if(a>b){ const t=a; a=b; b=t; }
            // snap to increments of 5
            a = Math.round(a/5)*5; b = Math.round(b/5)*5;
            minR.value = a; maxR.value = b; minN.value = a; maxN.value = b;
          }
          minR.addEventListener('input', sync);
          maxR.addEventListener('input', sync);
        })();
      </script>
      {% endif %}
    </div>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
    {% for v in items %}
      <div class="store-card card-glass p-4 cursor-pointer js-card" data-href="{% url 'store_product' v.id %}" tabindex="0" role="link" aria-label="View {{ v.product.name }}">
        <div class="mb-3 relative rounded-xl overflow-hidden border border-white/10">
          <div class="image-track no-scrollbar" data-track>
            {% if v.images.all %}
              {% for im in v.images.all|slice:':8' %}
                <div class="image-slide flex items-center justify-center bg-white/5 p-2">
                  <img src="{{ im.image.url }}" alt="{{ v.product.name }} image {{ forloop.counter }}" class="max-w-full h-auto" loading="lazy"/>
                </div>
              {% endfor %}
            {% else %}
              <div class="image-slide flex items-center justify-center text-slate-400 bg-white/5 p-6">
                No image
              </div>
            {% endif %}
          </div>
          {% if v.images.all|length > 1 %}
            <button type="button" class="store-arrow left btn-ghost js-stop" aria-label="Previous image" data-prev>‹</button>
            <button type="button" class="store-arrow right btn-ghost js-stop" aria-label="Next image" data-next>›</button>
          {% endif %}
        </div>
        <div class="flex items-center justify-between">
          <span class="chip">{{ v.product.brand }}</span>
          <span class="chip">{{ v.product.category }}</span>
        </div>
        <a href="{% url 'store_product' v.id %}" class="block mt-2 font-semibold line-clamp-2 hover:underline js-stop">{{ v.product.name }}</a>
        <div class="mt-1 text-sm text-slate-300">Size {{ v.size }}{% if v.colour %} • {{ v.colour }}{% endif %}</div>
        <div class="mt-3 flex items-center justify-between">
          <div class="text-xl font-extrabold">£{{ v.price|floatformat:2 }}</div>
          <form method="post" action="{% url 'store_product' v.id %}" class="js-stop">
            {% csrf_token %}
            <input type="hidden" name="qty" value="1">
            <button type="submit" class="px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-slate-900 text-sm">Add</button>
          </form>
        </div>
      </div>
    {% empty %}
      <div class="col-span-full text-slate-400">No items found.</div>
    {% endfor %}
  </div>
  <script>
    // Make entire card clickable, but ignore clicks on interactive elements
    (function(){
      const cards = document.querySelectorAll('.js-card');
      cards.forEach(c => {
        const go = ()=>{ const href = c.getAttribute('data-href'); if(href) window.location.href = href; };
        c.addEventListener('click', (e)=>{
          // If click originated inside an element marked js-stop or interactive controls, ignore
          if(e.target.closest('.js-stop, button, a, input, select, textarea')) return;
          go();
        });
        c.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); go(); } });
      });
    })();
    // Prev/Next buttons scroll the track by one slide width
    (function(){
      const cards = document.querySelectorAll('[data-track]');
      cards.forEach(track => {
        const prev = track.parentElement.querySelector('[data-prev]');
        const next = track.parentElement.querySelector('[data-next]');
        if(!prev || !next) return;
        const slideWidth = () => track.clientWidth; // each slide is 100% width
        const go = dir => {
          track.scrollTo({ left: track.scrollLeft + dir * slideWidth(), behavior: 'smooth' });
        };
        prev.addEventListener('click', e => { e.preventDefault(); go(-1); });
        next.addEventListener('click', e => { e.preventDefault(); go(1); });
      });
    })();
  </script>
</div>
{% endblock %}
