{% extends 'base.html' %}
{% load static %}
{% block content %}
  <div class="hero card p-6 mb-6">
    <div class="flex flex-wrap items-center gap-4">
      <img src="{% static 'branding/logo_neon.png' %}" class="h-14 w-auto logo-drop" alt="Closet Archive">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Closet Archive</h1>
        <p class="text-slate-300">Log products, auto-SKU, upload images, and export seamlessly.</p>
      </div>
      <form method="get" class="ml-auto flex items-center gap-2 w-full md:w-auto">
        <input type="text" name="q" value="{{ q }}" placeholder="Search name, brand, or SKU…" class="w-full md:w-80 bg-white/10 border border-white/10 rounded-xl p-3" />
        {% if status %}<input type="hidden" name="status" value="{{ status }}">{% endif %}
        <button class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">Search</button>
        <a href="{% url 'inventory:dashboard' %}" class="px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10">Reset</a>
        <a href="{% url 'inventory:product_create' %}" class="btn btn-primary">Add</a>
      </form>
    </div>
  </div>

  <div class="flex items-center gap-2 mb-4 flex-nowrap overflow-x-auto whitespace-nowrap">
    <a href="{% url 'inventory:dashboard' %}" class="px-3 py-1.5 pill {% if not status %}active{% endif %}">All</a>
    {% for s in statuses %}
      <a href="?status={{ s }}{% if q %}&q={{ q }}{% endif %}"
         class="px-3 py-1.5 pill {% if status == s %}active{% endif %}">{{ s }}</a>
    {% endfor %}
    <a href="?{% if q %}q={{ q }}&{% endif %}{% if status %}status={{ status }}&{% endif %}archived=0"
       class="px-3 py-1.5 pill {% if not show_archived %}active{% endif %}">Active</a>
    <a href="?{% if q %}q={{ q }}&{% endif %}{% if status %}status={{ status }}&{% endif %}archived=1"
       class="px-3 py-1.5 pill {% if show_archived %}active{% endif %}">Archived</a>
  </div>

  <form method="post" action="{% url 'inventory:bulk_update' %}">
    {% csrf_token %}
    <div class="rounded-2xl bg-white/5 border border-white/10 p-3 mb-4 flex items-center gap-2 flex-wrap">
      <label class="text-sm text-slate-300">Bulk edit:</label>
      <select name="set_status" class="bg-white/10 border border-white/10 rounded-xl p-2">
        <option value="">Set status…</option>
        {% for s in statuses %}
          <option value="{{ s }}">{{ s }}</option>
        {% endfor %}
      </select>
      <input type="text" name="set_location" placeholder="Set location…" class="bg-white/10 border border-white/10 rounded-xl p-2" />
      <input name="set_category" list="bulkCategoriesList" placeholder="Set category…" class="bg-white/10 border border-white/10 rounded-xl p-2" />
      <datalist id="bulkCategoriesList">
        {% for c in categories %}<option value="{{ c }}">{% endfor %}
      </datalist>
      <button class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-slate-900">Apply to selected</button>
      <button type="button" id="toggleAll" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Select all</button>
    </div>

    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
      {% for p in products %}
        <label class="block card transition overflow-hidden relative cursor-pointer">
          <input type="checkbox" name="ids" value="{{ p.pk }}" class="absolute top-3 left-3 h-5 w-5 rounded border-white/30 bg-white/10 z-10">
          <div class="p-4">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm text-slate-400">Main SKU</div>
              <div class="badge">{{ p.main_sku }}</div>
            </div>
            <h3 class="text-lg font-semibold line-clamp-2">
              <a href="{% url 'inventory:product_detail' p.pk %}" class="hover:underline">{{ p.name }}</a>
            </h3>
            <div class="mt-1 text-slate-400 text-sm">{{ p.brand }} — {{ p.category }}</div>
            {% with v=p.variants.first %}
              {% if v %}
                <div class="mt-2 text-xs text-slate-400">Status: <span class="badge">{{ v.status }}</span></div>
              {% endif %}
            {% endwith %}
            <div class="mt-3 flex items-center gap-2">
              <a href="{% url 'inventory:variant_create' p.pk %}" class="px-3 py-1.5 rounded-xl bg-white/10 hover:bg-white/20 text-sm">Add Variant</a>
              {% with vs=p.variants.all %}
                {% for v in vs|slice:':2' %}
                  <a href="{% url 'inventory:variant_delete' v.pk %}" class="px-2 py-1.5 rounded-xl bg-red-500/20 hover:bg-red-500/30 text-xs text-red-200" title="Delete {{ v.variant_sku }}">Delete {{ v.variant_sku }}</a>
                {% endfor %}
              {% endwith %}
              {% if not p.archived %}
              <form method="post" action="{% url 'inventory:product_archive' p.pk %}">
                {% csrf_token %}
                <button class="px-3 py-1.5 rounded-xl bg-white/10 hover:bg-white/20 text-sm" title="Archive">Archive</button>
              </form>
              {% else %}
              <form method="post" action="{% url 'inventory:product_unarchive' p.pk %}">
                {% csrf_token %}
                <button class="px-3 py-1.5 rounded-xl bg-white/10 hover:bg-white/20 text-sm" title="Restore">Unarchive</button>
              </form>
              {% endif %}
            </div>
          </div>
          {% with v=p.variants.all.0 %}
            {% if v and v.images.all %}
              <div class="grid grid-cols-3 gap-1 p-2">
                {% for img in v.images.all|slice:':3' %}
                  <img src="{{ img.image.url }}" class="h-24 w-full object-cover rounded-lg" alt="">
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
          <div class="p-4 border-t border-white/10 text-sm text-slate-400">
            {{ p.variants.count }} variant{{ p.variants.count|pluralize }}
          </div>
        </label>
      {% empty %}
        <div class="col-span-full rounded-xl bg-white/5 border border-white/10 p-8 text-center">
          <p>No products yet. <a class="underline" href="{% url 'inventory:product_create' %}">Create your first one</a>.</p>
        </div>
      {% endfor %}
    </div>
  </form>

  <script>
    const toggleBtn = document.getElementById('toggleAll');
    if (toggleBtn){
      toggleBtn.addEventListener('click', ()=>{
        const boxes = document.querySelectorAll('input[type=checkbox][name=ids]');
        const allChecked = Array.from(boxes).every(b=>b.checked);
        boxes.forEach(b=>b.checked = !allChecked);
      });
    }
  </script>
{% endblock %}
