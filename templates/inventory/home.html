{% extends 'base.html' %}
{% load form_extras %}
{% block content %}
  <div class="grid grid-cols-1 md:grid-cols-12 gap-4 stagger">
    <!-- Hero / Welcome -->
    <div class="md:col-span-12 rounded-2xl border border-white/10 p-6 bg-gradient-to-r from-indigo-500/10 via-fuchsia-500/10 to-emerald-500/10 reveal">
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight neon">Welcome back ðŸ‘‹</h1>
      <p class="text-slate-300 mt-1">Small steps, big wins. Keep listing â€” every item moves you closer to your goals.</p>
    </div>

    <!-- Row 2: Profit + Stock (5 + 7 = 12) -->
    <div class="md:col-span-5 widget p-5 reveal" tabindex="0">
      <div class="widget-accent accent-emerald"></div>
      <div class="flex items-center justify-between">
        <div class="text-sm muted">Total Profit (Sold)</div>
        <div class="text-xl">ðŸ’·</div>
      </div>
      <div class="metric-lg mt-2">
        {% if user.is_staff and not user.is_superuser %}
          <span class="money">Â£{{ total_profit|floatformat:2|mask_digits }}</span>
        {% else %}
          Â£<span class="countup" data-target="{{ total_profit|floatformat:2 }}" data-decimals="2"></span>
        {% endif %}
      </div>
      <div class="mt-2 muted text-sm">Net after platform fees and cost.</div>
      <div class="widget-extra">
        <div class="grid grid-cols-2 gap-2 mt-3 text-sm">
          <div class="card p-3">
            <div class="muted">Avg Profit / Sale</div>
            <div class="font-semibold">Â£{{ avg_profit_per_sale|floatformat:2 }}</div>
          </div>
          <div class="card p-3">
            <div class="muted">Top Category</div>
            <div class="font-semibold">{{ top_category_name|default:'â€”' }}</div>
          </div>
          <div class="col-span-2 card p-3">
            <div class="muted">Top Brand by Profit</div>
            <div class="font-semibold">{% if best_profit_brand %}{{ best_profit_brand.product__brand|default:'â€”' }} â€¢ Â£{{ best_profit_brand.p|floatformat:2 }}{% else %}â€”{% endif %}</div>
          </div>
        </div>
      </div>
      <!-- Tiny sparkline -->
      <svg class="mt-3 w-full h-10" viewBox="0 0 120 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="gradP" x1="0" y1="0" x2="120" y2="0" gradientUnits="userSpaceOnUse">
            <stop stop-color="#10b981"/>
            <stop offset="1" stop-color="#34d399"/>
          </linearGradient>
        </defs>
        <path d="M2 32 C 15 28, 25 22, 35 25 C 45 28, 55 15, 65 18 C 75 21, 90 10, 118 8" stroke="url(#gradP)" stroke-width="2" stroke-linecap="round" fill="none">
          <animate attributeName="stroke-dasharray" from="0,200" to="200,0" dur="1.2s" fill="freeze" />
        </path>
      </svg>
    </div>
    <!-- Stock Value (List) -->
    <div class="md:col-span-7 widget p-5 reveal" tabindex="0">
      <div class="widget-accent accent-blue"></div>
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm muted">Current Stock (List Value)</div>
          <div class="text-2xl font-bold mt-1">
            {% if user.is_staff and not user.is_superuser %}
              <span class="money">Â£{{ stock_list_value|floatformat:2|mask_digits }}</span>
            {% else %}
              Â£<span class="countup" data-target="{{ stock_list_value|floatformat:2 }}" data-decimals="2"></span>
            {% endif %}
          </div>
        </div>
        <div class="text-sm muted">Inventory Cost: <span class="font-semibold">
          {% if user.is_staff and not user.is_superuser %}
            <span class="money">Â£{{ stock_cost_value|floatformat:2|mask_digits }}</span>
          {% else %}
            Â£<span class="countup" data-target="{{ stock_cost_value|floatformat:2 }}" data-decimals="2"></span>
          {% endif %}
        </span></div>
      </div>
      <div class="mt-3 grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-slate-300">
        <div class="card p-3">
          <div class="muted">Potential Revenue (Listed)</div>
          <div class="text-lg font-semibold">
            {% if user.is_staff and not user.is_superuser %}
              <span class="money">Â£{{ listed_list_value|floatformat:2|mask_digits }}</span>
            {% else %}
              Â£<span class="countup" data-target="{{ listed_list_value|floatformat:2 }}" data-decimals="2"></span>
            {% endif %}
          </div>
        </div>
        <div class="card p-3">
          <div class="muted">Avg Margin (Sold)</div>
          <div class="text-lg font-semibold"><span class="countup" data-target="{{ avg_margin|floatformat:1 }}" data-decimals="1" data-suffix="%"></span></div>
        </div>
        <div class="card p-3">
          <div class="muted">Variants</div>
          <div class="text-lg font-semibold"><span class="countup" data-target="{{ totals.variants|default:0 }}" data-decimals="0"></span></div>
        </div>
      </div>
      <div class="widget-extra">
        <div class="grid grid-cols-3 gap-2 mt-3 text-sm">
          <div class="card p-3 text-center">
            <div class="muted">Unsold Units</div>
            <div class="font-semibold">{{ unsold_qty }}</div>
          </div>
          <div class="card p-3 text-center">
            <div class="muted">Brands</div>
            <div class="font-semibold">{{ brands_count }}</div>
          </div>
          <div class="card p-3 text-center">
            <div class="muted">Categories</div>
            <div class="font-semibold">{{ categories_count }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 2b: Donut + KPIs (5 + 7) -->
    <div class="md:col-span-5 widget p-5 reveal" tabindex="0">
      <div class="widget-accent accent-violet"></div>
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Inventory Mix</h2>
        <div class="text-xs text-slate-400">Total Qty: {{ total_qty }}</div>
      </div>
      <div class="flex items-center gap-4">
        <!-- Conic-gradient donut (no JS) -->
        <div class="relative w-28 h-28">
          <div class="absolute inset-0 rounded-full" style="background: conic-gradient({% if status_mix_segments %}{% for seg in status_mix_segments %}{{ seg.color }} {{ seg.frm }}% {{ seg.to }}%{% if not forloop.last %}, {% endif %}{% endfor %}{% else %}rgba(255,255,255,.12) 0% 100%{% endif %});"></div>
          <div class="absolute inset-4 rounded-full bg-slate-900/90 border border-white/10"></div>
        </div>
        <div class="text-sm flex-1 space-y-1">
          <div class="flex items-center justify-between"><span class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-sm" style="background:#10b981"></span>Sold</span><span>{{ status_counts.Sold|default:0 }}</span></div>
          <div class="flex items-center justify-between"><span class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-sm" style="background:#27A7FF"></span>Listed</span><span>{{ status_counts.Listed|default:0 }}</span></div>
          <div class="flex items-center justify-between"><span class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-sm" style="background:#f59e0b"></span>Draft</span><span>{{ status_counts.Draft|default:0 }}</span></div>
          {% if status_counts.Other %}
          <div class="flex items-center justify-between"><span class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-sm" style="background:#a78bfa"></span>Other</span><span>{{ status_counts.Other }}</span></div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="md:col-span-7 widget p-5 reveal" tabindex="0">
      <div class="widget-accent accent-emerald"></div>
      <h2 class="text-lg font-semibold mb-2">Key Ratios</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
        <div class="card p-3 text-center">
          <div class="muted">Sell-through</div>
          <div class="metric-sm"><span class="countup" data-target="{{ sell_through_pct }}" data-decimals="0" data-suffix="%"></span></div>
        </div>
        <div class="card p-3 text-center">
          <div class="muted">Avg List Price</div>
          <div class="metric-sm">
            {% if user.is_staff and not user.is_superuser %}
              <span class="money">Â£{{ avg_list_price|floatformat:2|mask_digits }}</span>
            {% else %}
              Â£<span class="countup" data-target="{{ avg_list_price|floatformat:2 }}" data-decimals="2"></span>
            {% endif %}
          </div>
        </div>
        <div class="card p-3 text-center">
          <div class="muted">Avg Cost</div>
          <div class="metric-sm">
            {% if user.is_staff and not user.is_superuser %}
              <span class="money">Â£{{ avg_cost|floatformat:2|mask_digits }}</span>
            {% else %}
              Â£<span class="countup" data-target="{{ avg_cost|floatformat:2 }}" data-decimals="2"></span>
            {% endif %}
          </div>
        </div>
        <div class="card p-3 text-center">
          <div class="muted">Categories</div>
          <div class="metric-sm"><span class="countup" data-target="{{ categories_count }}" data-decimals="0"></span></div>
        </div>
      </div>
      <div class="widget-extra">
        <div class="mt-3 text-sm card p-3">
          {% if next_target %}
            <div class="muted">Next Target</div>
            <div class="font-semibold">{% if user.is_staff and not user.is_superuser %}{{ progress_pct }}%{% else %}<span class="money">Â£{{ next_target|floatformat:2 }}</span>{% endif %}</div>
            <div class="mt-1 muted">Remaining</div>
            <div class="font-semibold">{% if user.is_staff and not user.is_superuser %}â€”{% else %}<span class="money">Â£{{ remaining_to_target|floatformat:2 }}</span>{% endif %}</div>
          {% else %}
            <div class="muted">Goal crushed â€” set a new milestone!</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Row 3: 4 Metrics (3 + 3 + 3 + 3 = 12) -->
    <div class="metrics-sync contents">
    <div class="md:col-span-3 widget p-5 reveal metrics-item" tabindex="0">
      <div class="widget-accent accent-blue"></div>
      <div class="text-sm muted">Sold</div>
      <div class="text-3xl font-bold mt-1"><span class="countup" data-target="{{ totals.sold|default:0 }}" data-decimals="0"></span></div>
      <div class="widget-extra">
        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
          <div class="card p-3 text-center">
            <div class="muted">Total Profit</div>
            <div class="font-semibold">{% if user.is_staff and not user.is_superuser %}<span class="money">Â£{{ total_profit|floatformat:2|mask_digits }}</span>{% else %}Â£{{ total_profit|floatformat:2 }}{% endif %}</div>
          </div>
          <div class="card p-3 text-center">
            <div class="muted">Avg / Sale</div>
            <div class="font-semibold">{% if user.is_staff and not user.is_superuser %}<span class="money">Â£{{ avg_profit_per_sale|floatformat:2|mask_digits }}</span>{% else %}Â£{{ avg_profit_per_sale|floatformat:2 }}{% endif %}</div>
          </div>
          <a href="{% url 'inventory:dashboard' %}?status=Sold" class="col-span-2 btn btn-primary text-center">View Sold</a>
        </div>
      </div>
    </div>
    <div class="md:col-span-3 widget p-5 reveal metrics-item" tabindex="0">
      <div class="widget-accent accent-violet"></div>
      <div class="text-sm muted">On Sale</div>
      <div class="text-3xl font-bold mt-1"><span class="countup" data-target="{{ totals.listed|default:0 }}" data-decimals="0"></span></div>
      <div class="widget-extra">
        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
          <div class="card p-3 text-center">
            <div class="muted">List Value</div>
            <div class="font-semibold">{% if user.is_staff and not user.is_superuser %}<span class="money">Â£{{ listed_list_value|floatformat:2|mask_digits }}</span>{% else %}Â£{{ listed_list_value|floatformat:2 }}{% endif %}</div>
          </div>
          <div class="card p-3 text-center">
            <div class="muted">Avg Price</div>
            <div class="font-semibold">{% if user.is_staff and not user.is_superuser %}<span class="money">Â£{{ avg_list_price|floatformat:2|mask_digits }}</span>{% else %}Â£{{ avg_list_price|floatformat:2 }}{% endif %}</div>
          </div>
          <a href="{% url 'inventory:dashboard' %}?status=Listed" class="col-span-2 btn btn-primary text-center">View Listed</a>
        </div>
      </div>
    </div>
    <div class="md:col-span-3 widget p-5 reveal metrics-item" tabindex="0">
      <div class="widget-accent accent-amber"></div>
      <div class="text-sm muted">Drafts</div>
      <div class="text-3xl font-bold mt-1"><span class="countup" data-target="{{ totals.draft|default:0 }}" data-decimals="0"></span></div>
      <div class="widget-extra">
        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
          <div class="card p-3 text-center">
            <div class="muted">Unsold Units</div>
            <div class="font-semibold">{{ unsold_qty }}</div>
          </div>
          <div class="card p-3 text-center">
            <div class="muted">Categories</div>
            <div class="font-semibold">{{ categories_count }}</div>
          </div>
          <a href="{% url 'inventory:dashboard' %}?status=Draft" class="col-span-2 btn btn-primary text-center">View Drafts</a>
        </div>
      </div>
    </div>
    <div class="md:col-span-3 widget p-5 reveal metrics-item" tabindex="0">
      <div class="widget-accent accent-pink"></div>
      <div class="text-sm muted">Products</div>
      <div class="text-3xl font-bold mt-1"><span class="countup" data-target="{{ totals.products|default:0 }}" data-decimals="0"></span></div>
      <div class="widget-extra">
        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
          <div class="card p-3 text-center">
            <div class="muted">Brands</div>
            <div class="font-semibold">{{ brands_count }}</div>
          </div>
          <div class="card p-3 text-center">
            <div class="muted">Categories</div>
            <div class="font-semibold">{{ categories_count }}</div>
          </div>
          <a href="{% url 'inventory:dashboard' %}" class="col-span-2 btn btn-primary text-center">Open Dashboard</a>
        </div>
      </div>
    </div>
    </div>

    <!-- Row 4: Milestone + Categories (7 + 5 = 12) -->
    <div class="md:col-span-7 widget p-5 reveal" tabindex="0">
      <div class="widget-accent accent-violet"></div>
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm muted">Next Profit Milestone</div>
          <div class="text-xl font-semibold">
            {% if next_target %}
              {% if user.is_staff and not user.is_superuser %}
                {{ progress_pct }}%
              {% else %}
                Â£{{ total_profit|floatformat:2 }} / Â£{{ next_target|floatformat:2 }}
              {% endif %}
            {% else %}
              You smashed all milestones â€” time for a new goal! ðŸŽ‰
            {% endif %}
          </div>
        </div>
        {% if next_target %}
        <div class="w-72 progress">
          <span data-width="{{ progress_pct }}%"></span>
        </div>
        {% endif %}
      </div>
      <p class="text-sm muted mt-3">Tip: Refresh older listings with better photos and keywords to boost conversions.</p>
    </div>

    <!-- Top Categories -->
    <div class="md:col-span-5 widget p-5 reveal" tabindex="0">
      <div class="widget-accent accent-amber"></div>
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Top Categories (Sold)</h2>
        <a href="{% url 'inventory:dashboard' %}" class="text-sm underline">Dashboard â†’</a>
      </div>
      <div class="space-y-2">
        {% for row in top_categories %}
          <div class="list-row">
            <div class="list-title">{{ row.category }}</div>
            <div class="flex items-center gap-2">
              <div class="w-28 progress"><span data-width="{{ row.pct }}%"></span></div>
              <span class="badge">{{ row.count }}</span>
            </div>
          </div>
        {% empty %}
          <div class="text-slate-400">No sales yet â€” your first is around the corner.</div>
        {% endfor %}
      </div>
    </div>

    <!-- Row 5: Quick Search + Recent + Top Brands (8 + 4 = 12) -->
    <div class="md:col-span-8 widget p-5 reveal" tabindex="0">
      <div class="widget-accent accent-blue"></div>
      <div class="mb-4">
        <form method="get" action="{% url 'inventory:dashboard' %}" class="flex gap-2">
          <label for="quick-search" class="sr-only">Quick search</label>
          <input id="quick-search" name="q" placeholder="Quick search by SKU, name, brand..." class="flex-1 bg-white/10 border border-white/10 rounded-xl p-3" />
          <button type="submit" class="btn btn-primary mobile-full">Search</button>
        </form>
      </div>
      <h2 class="text-xl font-semibold mb-3">Recent Activity</h2>
      <div class="-mx-3 overflow-x-auto snap-x snap-mandatory md:mx-0 md:overflow-visible md:snap-none">
        <div class="px-3 flex gap-4 md:block md:px-0 md:space-y-3">
          {% for v in recent %}
            <a href="{% url 'inventory:product_detail' v.product.pk %}#var-{{ v.pk }}"
               class="block min-w-[260px] md:min-w-0 md:w-auto card p-3 snap-start"
               aria-label="Open {{ v.product.name }} ({{ v.variant_sku }})">
              <div class="flex items-center gap-3">
                <div class="text-xs font-mono bg-white/10 rounded px-2 py-1">{{ v.variant_sku }}</div>
                <div class="text-slate-200 truncate">{{ v.product.name }}</div>
              </div>
              <div class="text-slate-400 text-xs mt-1 truncate">{{ v.product.brand }} â€¢ {{ v.product.category }} â€¢ {{ v.size }} â€¢ {{ v.status }}</div>
              <div class="mt-2">
                {% if v.status == 'Sold' %}
                  <span class="badge">{% if user.is_staff and not user.is_superuser %}<span class="money">Â£{{ v.profit|floatformat:2|mask_digits }}</span>{% else %}Â£{{ v.profit|floatformat:2 }}{% endif %} profit</span>
                {% else %}
                  <span class="badge">Â£{{ v.price|floatformat:2 }} listed</span>
                {% endif %}
              </div>
            </a>
          {% empty %}
            <div class="text-slate-400">No activity yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Top Brands -->
    <div class="md:col-span-4 widget p-5 reveal" tabindex="0">
      <div class="widget-accent accent-pink"></div>
      <h2 class="text-xl font-semibold mb-3">Top Brands (Sold)</h2>
      <div class="space-y-2">
        {% for row in top_brands %}
          <div class="list-row">
            <div class="list-title">{{ row.product__brand }}</div>
            <div>
              <span class="badge">{{ row.count }}</span>
              <span class="muted text-sm ml-2">{% if user.is_staff and not user.is_superuser %}<span class="money">Â£{{ row.profit|floatformat:2|mask_digits }}</span>{% else %}Â£{{ row.profit|floatformat:2 }}{% endif %}</span>
            </div>
          </div>
        {% empty %}
          <div class="text-slate-400">No brands yet.</div>
        {% endfor %}
      </div>
      <div class="widget-extra">
        <div class="mt-3 text-sm card p-3">
          <div class="muted">Tip</div>
          <div>Click Dashboard to filter by your top brands and refresh stale listings.</div>
        </div>
      </div>
    </div>

    <!-- Row 6: Quick Actions full width to avoid gaps -->
    <div class="md:col-span-12 widget p-5 reveal" tabindex="0">
      <div class="widget-accent accent-emerald"></div>
      <h2 class="text-xl font-semibold mb-3">Quick Actions</h2>
      <div class="grid grid-cols-2 gap-2">
        <a href="{% url 'inventory:product_create' %}" class="btn btn-primary text-center">New Product</a>
        <a href="{% url 'inventory:dashboard' %}" class="px-4 py-2 rounded-2xl bg-white/10 hover:bg-white/20 text-center col-span-1">Open Dashboard</a>
        <a href="{% url 'inventory:settings' %}" class="px-4 py-2 rounded-2xl bg-white/10 hover:bg-white/20 text-center">Settings</a>
        <a href="{% url 'inventory:export_to_list_zip' %}" class="px-4 py-2 rounded-2xl bg-emerald-500 hover:bg-emerald-400 text-slate-900 text-center">Download To List</a>
      </div>
      <div class="mt-4 text-slate-300 text-sm">
        Aim for 1 listing a day. Your future self will thank you.
      </div>
    </div>

    <!-- Row 6b: Top Locations -->
    <div class="md:col-span-12 widget p-5 reveal" tabindex="0">
      <div class="widget-accent accent-violet"></div>
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Top Locations</h2>
        <span class="text-xs text-slate-400">Where your stock lives</span>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        {% for row in top_locations %}
          <div class="list-row">
            <div class="list-title">{{ row.location }}</div>
            <div class="flex items-center gap-2">
              <div class="w-28 progress"><span class="loc-bar" data-q="{{ row.q }}" data-max="{{ top_locations_max }}"></span></div>
              <span class="badge">{{ row.q }}</span>
            </div>
          </div>
        {% empty %}
          <div class="text-slate-400">No location data yet.</div>
        {% endfor %}
      </div>
    </div>
    <script>
      // Compute progress width for location bars
      (function(){
        const bars = document.querySelectorAll('.loc-bar');
        bars.forEach(b=>{
          const q = parseFloat(b.getAttribute('data-q')||'0');
          const m = parseFloat(b.getAttribute('data-max')||'0');
          const pct = m > 0 ? Math.round((q/m)*100) : 0;
          const width = pct + '%';
          b.setAttribute('data-width', width);
          b.style.width = width;
        });
      })();
    </script>
  </div>
  <script>
    // Sync-open behavior for the four metric widgets: hover/focus on one opens all
    (function(){
      const container = document.querySelector('.metrics-sync');
      if(!container) return;
      const items = container.querySelectorAll('.metrics-item');
      let hoverCount = 0;
      const open = ()=> container.classList.add('sync-open');
      const close = ()=> container.classList.remove('sync-open');
      items.forEach(it=>{
        it.addEventListener('mouseenter', ()=>{ hoverCount++; open(); });
        it.addEventListener('mouseleave', ()=>{ hoverCount = Math.max(0, hoverCount-1); if(hoverCount===0) close(); });
        it.addEventListener('focusin', open);
        it.addEventListener('focusout', ()=>{
          // Delay slightly to allow focus to move within another metrics item
          setTimeout(()=>{
            const active = container.contains(document.activeElement);
            if(!active) close();
          }, 80);
        });
      });
    })();
  </script>
{% endblock %}
